# Deployment script for AWS Lightsail production environment
name: Deploy to AWS Lightsail

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch: # Allow manual deployment

env:
  DEPLOYMENT_PATH: /opt/chemouflage-card-shop

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to AWS Lightsail
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: ${{ secrets.LIGHTSAIL_SSH_PORT || 22 }}
          timeout: 300s
          script: |
            set -e  # Exit on any error

            echo "ðŸš€ Starting deployment to AWS Lightsail..."

            # Navigate to application directory
            cd ${{ env.DEPLOYMENT_PATH }}

            # Pull latest code from repository
            echo "ðŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main

            # Create environment file if it doesn't exist
            if [ ! -f .env ]; then
              echo "ðŸ“ Creating environment file..."
              cat > .env << EOF
            # Database Configuration
            MONGODB_URL=mongodb://admin:${{ secrets.MONGODB_PASSWORD }}@mongodb:27017/chemouflage?authSource=admin

            # Redis Configuration
            REDIS_URL=redis://redis:6379
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_DB=0
            REDIS_POOL_MAX_CONNECTIONS=20

            # Authentication
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            ALGORITHM=HS256
            ACCESS_TOKEN_EXPIRE_MINUTES=30

            # API Configuration
            API_V1_STR=/api/v1
            PROJECT_NAME=Chemouflage Card Shop API
            ENVIRONMENT=production

            # Email Configuration
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            MAIL_FROM=${{ secrets.MAIL_FROM }}
            MAIL_FROM_NAME=Chemouflage Card Shop
            MAIL_SERVER=${{ secrets.MAIL_SERVER }}
            MAIL_PORT=${{ secrets.MAIL_PORT }}
            MAIL_STARTTLS=${{ secrets.MAIL_STARTTLS }}
            MAIL_SSL_TLS=${{ secrets.MAIL_SSL_TLS }}
            USE_CREDENTIALS=true
            VALIDATE_CERTS=true

            # URLs
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            BACKEND_URL=${{ secrets.BACKEND_URL }}

            # Payment Configuration
            AAMARPAY_SANDBOX=${{ secrets.AAMARPAY_SANDBOX }}
            AAMARPAY_STORE_ID=${{ secrets.AAMARPAY_STORE_ID }}
            AAMARPAY_SIGNATURE_KEY=${{ secrets.AAMARPAY_SIGNATURE_KEY }}

            # Cache Configuration
            CACHE_TTL_SECONDS=300
            CACHE_TTL_PRODUCTS=600
            CACHE_TTL_USER_SESSIONS=3600
            EOF
            fi
              # Stop existing services gracefully
            echo "ðŸ›‘ Stopping existing services..."
            docker-compose -f docker-compose.prod.yml down --remove-orphans || true

            # Build and start services
            echo "ðŸ”¨ Building and starting services..."
            docker-compose -f docker-compose.prod.yml up -d --build

            # Wait for services to be ready
            echo "â³ Waiting for services to be ready..."
            sleep 45

            # Run health checks
            echo "ðŸ” Running health checks..."
            ./health-check.sh || echo "âš ï¸ Health check script not found or failed"

            # Check service status
            echo "ðŸ“Š Checking service status..."
            docker-compose ps

            # Clean up old images and containers
            echo "ðŸ§¹ Cleaning up old Docker resources..."
            docker system prune -f --volumes
              echo "âœ… Deployment completed successfully!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: ${{ secrets.LIGHTSAIL_SSH_PORT || 22 }}
          script: |
            # Test API endpoint
            curl -f http://localhost:8000/health || echo "API health check failed"

            # Test frontend
            curl -f http://localhost/health || echo "Frontend health check failed"
              # Check logs for errors
            cd ${{ env.DEPLOYMENT_PATH }}
            docker-compose -f docker-compose.prod.yml logs --tail=50 backend | grep -i error || echo "No errors found in backend logs"

      # - name: Notify deployment status
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     channel: "#deployments"
      #     text: |
      #       Deployment to AWS Lightsail: ${{ job.status }}
      #       Repository: ${{ github.repository }}
      #       Branch: ${{ github.ref_name }}
      #       Commit: ${{ github.sha }}
      #       Author: ${{ github.actor }}
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
